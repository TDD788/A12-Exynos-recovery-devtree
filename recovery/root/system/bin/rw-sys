#!/system/bin/sh
#!/bin/env sh

rw_sysimg() {
    resize2fs "/data/rw-sys/system.img" 8G
    e2fsck -E unshare_blocks "/data/rw-sys/system.img"
    resize2fs -M "/data/rw-sys/system.img"
    echo "Done"
    exit
}

rw_sys_location() {
    UDATA_CHK="/dev/block/by-name/userdata"
    grep -q "${UDATA_CHK}" /proc/mounts
    if [ $? -eq 0 ]; then 
        if [ ! -d "/data/rw-sys" ]; then
            mkdir /data/rw-sys
            if [ ! -d "/data/rw-sys" ]; then 
                echo "Please remount data to rw"
                exit 1
            fi
        fi 
    else 
        echo "Mount Data to Read/Write Please before proceeding..."
        exit 1
    fi 
}

selected_img() {
    mv "$FILE" /data/rw-sys/system.img
    rw_sysimg
}

blocksys() {
    dd if=/dev/block/mapper/system of=/data/rw-sys/system.img bs=512M
    rw_sysimg
}

front_page() {
    cat /system/var/rw-sys/frontpage
    echo "Enter option [ 1 | 2 ]:  "
    read option
    case $option in
        1)
            echo "Enter file location (Check for spelling, it's case sensitive):   "
            read FILE
            if [ -f "$FILE" ]; then
                selected_img
            else 
                echo "Error: $FILE does not exist"
                exit 1
            fi
            ;;
        2)
            blocksys
            ;;
        *)
            echo "$option is not an option"
            exit 1
            ;;
    esac
}

rw_sys_location

case "$1" in 
    "--file")
        if [ -z "$3" ]; then
            echo "Empty directory, please insert it"
            exit 1
        else
            if [ -f "$2" ]; then
                selected_img
            else 
                echo "Error: $2 does not exist"
                exit 1
            fi
        fi
        ;;
    "--system")
        blocksys
        ;;
esac

front_page

